version: '3.8'

services:
  # Database - Core dependency
  lamp-server:
    image: mattrayner/lamp:latest-1804
    container_name: lamp-server
    ports:
      - "3306:3306"
    networks:
      - soft40051_network
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DB}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
    volumes:
      - mysql_data:/var/lib/mysql
      - ./db:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10
    restart: unless-stopped

  # MQTT Broker
  mqtt-broker:
    image: eclipse-mosquitto:2
    container_name: mqtt-broker
    ports:
      - "1883:1883"
      - "9001:9001"
    networks:
      - soft40051_network
    volumes:
      - ./mqtt/config/mosquitto.conf:/mosquitto/config/mosquitto.conf
      - mqtt_data:/mosquitto/data
    restart: unless-stopped

  # Build Aggregator from source
  aggregator:
    build:
      context: ./AggService
      dockerfile: ../Dockerfile.agg
    container_name: aggregator
    expose:
      - "${AGG_PORT}"
    ports:
      - "${AGG_PORT}:${AGG_PORT}"
    networks:
      - soft40051_network
    volumes:
      - ./storage:/storage
    env_file:
      - ./.env
    environment:
      - MYSQL_HOST=lamp-server
      - MYSQL_PORT=3306
      - MYSQL_DATABASE=${MYSQL_DB}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - STORAGE_NODES=sftp-node1,sftp-node2,sftp-node3,sftp-node4
      - SFTP_USER=root
      - SERVER_PORT=${AGG_PORT}
    depends_on:
      lamp-server:
        condition: service_healthy
      mqtt-broker:
        condition: service_started
      sftp-node1:
        condition: service_started
      sftp-node2:
        condition: service_started
      sftp-node3:
        condition: service_started
      sftp-node4:
        condition: service_started
    restart: unless-stopped

  # Build Load Balancer from source
  load-balancer:
    build:
      context: ./cloudlb
      dockerfile: ../Dockerfile.lb
    container_name: load-balancer
    expose:
      - "${LB_PORT}"
    ports:
      - "${LB_PORT}:${LB_PORT}"
    networks:
      - soft40051_network
    env_file:
      - ./.env
    environment:
      - AGGREGATOR_HOST=aggregator
      - AGGREGATOR_PORT=${AGG_PORT}
      - MQTT_BROKER_HOST=mqtt-broker
      - MQTT_BROKER_PORT=1883
      - SERVER_PORT=${LB_PORT}
    depends_on:
      - aggregator
      - mqtt-broker
    restart: unless-stopped

  # SFTP Storage Nodes
  sftp-node1:
    image: lscr.io/linuxserver/openssh-server:latest
    container_name: sftp-node1
    ports:
      - "4848:22"
    networks:
      - soft40051_network
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Etc/UTC
      - USER_NAME=root
      - USER_PASSWORD=${SFTP_PASS}
      - SUDO_ACCESS=true
    volumes:
      - ./storage/node1:/data
    restart: unless-stopped

  sftp-node2:
    image: lscr.io/linuxserver/openssh-server:latest
    container_name: sftp-node2
    ports:
      - "4849:22"
    networks:
      - soft40051_network
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Etc/UTC
      - USER_NAME=root
      - USER_PASSWORD=${SFTP_PASS}
      - SUDO_ACCESS=true
    volumes:
      - ./storage/node2:/data
    restart: unless-stopped

  sftp-node3:
    image: lscr.io/linuxserver/openssh-server:latest
    container_name: sftp-node3
    ports:
      - "4850:22"
    networks:
      - soft40051_network
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Etc/UTC
      - USER_NAME=root
      - USER_PASSWORD=${SFTP_PASS}
      - SUDO_ACCESS=true
    volumes:
      - ./storage/node3:/data
    restart: unless-stopped

  sftp-node4:
    image: lscr.io/linuxserver/openssh-server:latest
    container_name: sftp-node4
    ports:
      - "4851:22"
    networks:
      - soft40051_network
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Etc/UTC
      - USER_NAME=root
      - USER_PASSWORD=${SFTP_PASS}
      - SUDO_ACCESS=true
    volumes:
      - ./storage/node4:/data
    restart: unless-stopped

  # Optional: Jenkins for CI/CD
  jenkins:
    image: jenkins/jenkins:lts
    container_name: jenkins
    ports:
      - "8081:8080"
      - "50000:50000"
    networks:
      - soft40051_network
    volumes:
      - jenkins_data:/var/jenkins_home
    restart: unless-stopped

  # Optional: Gitea for Git hosting
  gitea:
    image: gitea/gitea:latest
    container_name: gitea
    ports:
      - "3000:3000"
      - "2222:22"
    networks:
      - soft40051_network
    volumes:
      - gitea_data:/data
    restart: unless-stopped

networks:
  soft40051_network:
    driver: bridge

volumes:
  mysql_data:
  mqtt_data:
  jenkins_data:
  gitea_data:
