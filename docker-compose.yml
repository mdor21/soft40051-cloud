version: '3.8'

services:
  # Main Application / GUI
  ntu-vm-soft40051:
    image: pedrombmachado/ntu_lubuntu:soft40051
    container_name: ntu-vm-soft40051
    ports:
      - "3390:3389"  # RDP
      - "2022:22"    # SSH
    networks:
      - soft40051_network
    volumes:
      - ./app:/workspace
      - ./config:/config
    environment:
      - DISPLAY=:1
      - LOAD_BALANCER_HOST=load-balancer
      - LOAD_BALANCER_PORT=6869
    depends_on:
      - load-balancer
      - lamp-server
      - mqtt-broker
    restart: unless-stopped

  # Load Balancer
  load-balancer:
    image: pedrombmachado/ntu_lubuntu:soft40051
    container_name: load-balancer
    expose:
      - "6869"
    networks:
      - soft40051_network
    volumes:
      - ./load-balancer:/app
    environment:
      - AGGREGATOR_HOST=aggregator
      - AGGREGATOR_PORT=9000
      - MQTT_BROKER_HOST=mqtt-broker
      - MQTT_BROKER_PORT=1883
    command: java -jar /app/load-balancer.jar
    depends_on:
      - aggregator
      - mqtt-broker
    restart: unless-stopped

  # Aggregator Service
  aggregator:
    image: pedrombmachado/ntu_lubuntu:soft40051
    container_name: aggregator
    expose:
      - "9000"
    networks:
      - soft40051_network
    volumes:
      - ./aggregator:/app
      - ./storage:/storage
    environment:
      - MYSQL_HOST=lamp-server
      - MYSQL_PORT=3306
      - MYSQL_DATABASE=dbtutorial
      - MYSQL_USER=soft40051
      - MYSQL_PASSWORD=cloud2024
      - MYSQL
